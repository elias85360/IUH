services:
  keycloak-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 5s
      timeout: 3s
      retries: 10

  db:
    image: timescale/timescaledb:2.14.2-pg14
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: iot
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - default

  redis:
    image: redis:7.2-alpine
    ports:
      - "6379:6379"
    networks:
      - default

  keycloak:
    image: quay.io/keycloak/keycloak:26.4.2
    command: ["start", "--http-enabled=true", "--import-realm"]
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-db
      KC_DB_URL_PORT: 5432
      KC_DB_URL_DATABASE: keycloak
      KC_DB_SCHEMA: public
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      # Hostname public du serveur (prod = 192.168.2.30 en LAN IUH)
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-192.168.2.30}
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
      KC_HOSTNAME_STRICT: "false"
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak/realm-iot.json:/opt/keycloak/data/import/realm-iot.json:ro
    depends_on:
      - keycloak-db
    networks:
      - default

  api:
    build:
      context: ../backend
    environment:
      # Persistence / cache
      DATABASE_URL: postgres://postgres:postgres@db:5432/iot
      REDIS_URL: redis://redis:6379
      TSDB_MIRROR: "1"
      TSDB_READ: "0"
      PREAGG_RETENTION_DAYS: "90"

      # Security / OIDC
      RBAC_ENFORCE: "1"
      ALLOW_API_KEY_WITH_RBAC: "1"
      OIDC_ISSUER_URL: http://keycloak:8080/realms/iot
      OIDC_CLIENT_ID: iot-dashboard
      OIDC_REQUIRE_AUD: "0"
      OIDC_IGNORE_ISSUER: "1"
      OIDC_JWKS_URL: http://keycloak:8080/realms/iot/protocol/openid-connect/certs
      TRUST_PROXY: "true"
      RATE_LIMIT: 1000/1m

      # CORS (SPA servie par nginx sur 192.168.2.30)
      # CORS_ORIGIN: http://localhost
      CORS_ORIGIN: http://192.168.2.30

      # Observabilité
      LOG_LEVEL: info

      # Ingestion: Kienlab via proxy nginx
      DATA_SOURCE: kienlab
      KIENLAB_BASE: "http://nginx/kienlab"
      KIENLAB_DEVICES: "F0:24:F9:57:59:18,3C:8A:1F:0B:7C:C4,D4:8A:FC:A5:ED:E0,3C:8A:1F:0B:70:D4,D4:8A:FC:99:66:68,3C:8A:1F:0B:6F:A8"
      KIENLAB_AUTH_SCHEME: ""
      KIENLAB_API_KEY: ""
      KIENLAB_LENGTH: "1000"
      KIENLAB_POLL_MS: "5000"
      KIENLAB_MAX_INIT_ROWS: "500"
      KIENLAB_DEBUG: "1"

      # Clé API de test (à supprimer ou remplacer pour la prod réelle)
      API_KEY: "testkey"

      # --- Email alerts (SMTP) ---
      # Renseigner ces valeurs via un .env serveur, ne pas commiter les secrets
      SMTP_HOST: ${SMTP_HOST:-"smtp.gmail.com"}
      SMTP_PORT: ${SMTP_PORT:-"465"}
      SMTP_SECURE: ${SMTP_SECURE:-"true"}
      SMTP_USER: ${SMTP_USER:-""}
      SMTP_PASS: ${SMTP_PASS:-""}
      ALERTS_FROM: ${ALERTS_FROM:-""}
      ALERTS_TO: ${ALERTS_TO:-""}
      ALERTS_MIN_LEVEL: "crit"
      ALERTS_COOLDOWN_SECONDS: "300"
    volumes:
      # Persist thresholds.json, assets-meta.json et logs d’audit
      - api_data:/app/backend/data
      - api_logs:/var/log/iot
    ports:
      - "4001:4000"
    depends_on:
      - db
      - redis
      - keycloak
    healthcheck:
      # Healthcheck sur /metrics (pas d’auth)
      test:
        [
          "CMD-SHELL",
          "node -e \"fetch('http://localhost:4000/metrics').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

  prometheus:
    image: prom/prometheus:v2.55.0
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - api
    networks:
      - default

  grafana:
    image: grafana/grafana:10.4.5
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
    depends_on:
      - prometheus
    networks:
      - default
    volumes:
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/provisioning/alerting:/etc/grafana/provisioning/alerting:ro

  nginx:
    build:
      context: ..
      dockerfile: infra/nginx.Dockerfile
      args:
        # Config OIDC injectée au build Vite pour la prod IUH
        VITE_OIDC_ISSUER_URL: "http://192.168.2.30:8080/realms/iot"
        VITE_OIDC_CLIENT_ID: "iot-dashboard"
        # IMPORTANT : on met le frontend sur http://192.168.2.30:8081
        VITE_OIDC_REDIRECT_URI: "http://192.168.2.30:8081"
        VITE_REQUIRE_AUTH: "1"
        # VITE_API_BASE: ""   # inutile derrière nginx
        # VITE_DATA_SOURCE: "" # on utilise l’API backend via nginx
    ports:
      - "8081:80"
      # - "443:443"  # désactivé pour l’instant
    environment:
      # Proxy vers Kienlab
      KIENLAB_PROXY_TARGET: "http://eprophet.kienlab.com"
    depends_on:
      - api
    volumes:
      - ./nginx/certs:/etc/nginx/certs:ro
    networks:
      - default

volumes:
  api_data: {}
  api_logs: {}
  keycloak_db_data: {}

networks:
  default:
    name: iot-net
