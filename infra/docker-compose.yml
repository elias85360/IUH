services:
  # -------------------------
  # Base de données Keycloak
  # -------------------------
  keycloak-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${KEYCLOAK_DB_NAME:-keycloak}
      POSTGRES_USER: ${KEYCLOAK_DB_USER:-keycloak}
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${KEYCLOAK_DB_USER:-keycloak} -d ${KEYCLOAK_DB_NAME:-keycloak}"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - default

  # -------------------------
  # Base de données IoT (Timescale/Postgres)
  # -------------------------
  db:
    image: timescale/timescaledb:2.14.2-pg14
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-iot}
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-iot}"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - default


  # -------------------------
  # Redis (cache + rate limiting)
  # -------------------------
  redis:
    image: redis:7.2-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - default

  # -------------------------
  # Keycloak (auth OIDC)
  # -------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:26.4.2
    restart: unless-stopped
    command: ["start", "--http-enabled=true", "--import-realm"]
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-db
      KC_DB_URL_PORT: 5432
      KC_DB_URL_DATABASE: ${KEYCLOAK_DB_NAME:-keycloak}
      KC_DB_USERNAME: ${KEYCLOAK_DB_USER:-keycloak}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}
      KC_DB_SCHEMA: public
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-192.168.2.30}
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak/realm-iot.json:/opt/keycloak/data/import/realm-iot.json:ro
    depends_on:
      keycloak-db:
        condition: service_healthy
    networks:
      - default

  # -------------------------
  # Backend API IoT
  # -------------------------
  api:
    build:
      context: ../backend
    restart: unless-stopped
    environment:
      # Runtime
      NODE_ENV: production
      PORT: 4000
      TRUST_PROXY: "true"
      LOG_LEVEL: ${API_LOG_LEVEL:-info}

      # Persistence / cache
      DATABASE_URL: postgres://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@db:5432/${DB_NAME:-iot}
      REDIS_URL: redis://redis:6379
      TSDB_MIRROR: "1"
      TSDB_READ: "0"
      PREAGG_RETENTION_DAYS: "90"

      # Sécurité / OIDC / RBAC
      RBAC_ENFORCE: "1"
      ALLOW_API_KEY_WITH_RBAC: "0"
      OIDC_ISSUER_URL: ${OIDC_ISSUER_URL_INTERNAL:-http://keycloak:8080/realms/iot}
      OIDC_CLIENT_ID: ${OIDC_CLIENT_ID:-iot-dashboard}
      OIDC_REQUIRE_AUD: "0"
      OIDC_IGNORE_ISSUER: "0"
      OIDC_JWKS_URL: ${OIDC_JWKS_URL_INTERNAL:-http://keycloak:8080/realms/iot/protocol/openid-connect/certs}
      RATE_LIMIT: ${API_RATE_LIMIT:-1000/1m}

      # CORS (SPA servie par nginx)
      CORS_ORIGIN: ${CORS_ORIGIN:-http://192.168.2.30:8081,http://localhost:5174,http://localhost:8081}

      # Ingestion Kienlab via proxy nginx
      DATA_SOURCE: ${DATA_SOURCE:-kienlab}
      KIENLAB_BASE: ${KIENLAB_BASE:-http://nginx/kienlab}
      KIENLAB_DEVICES: ${KIENLAB_DEVICES}
      KIENLAB_AUTH_SCHEME: ${KIENLAB_AUTH_SCHEME:-}
      KIENLAB_API_KEY: ${KIENLAB_API_KEY:-}
      KIENLAB_LENGTH: ${KIENLAB_LENGTH:-1000}
      KIENLAB_POLL_MS: ${KIENLAB_POLL_MS:-5000}
      KIENLAB_MAX_INIT_ROWS: ${KIENLAB_MAX_INIT_ROWS:-500}
      KIENLAB_DEBUG: ${KIENLAB_DEBUG:-0}

      # API key technique (à changer en prod réelle)
      API_KEY: ${API_KEY:-}

      # Email alerts (SMTP)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_SECURE: ${SMTP_SECURE}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      ALERTS_FROM: ${ALERTS_FROM}
      ALERTS_TO: ${ALERTS_TO}
      ALERTS_MIN_LEVEL: ${ALERTS_MIN_LEVEL:-crit}
      ALERTS_COOLDOWN_SECONDS: ${ALERTS_COOLDOWN_SECONDS:-300}

      # Protection /metrics optionnelle
      METRICS_API_KEY: ${METRICS_API_KEY:-}

    volumes:
      # Persist thresholds.json, assets-meta.json et logs d’audit
      - api_data:/app/backend/data
      - api_logs:/var/log/iot
    ports:
      - "4001:4000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      keycloak:
        condition: service_started
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"fetch('http://localhost:4000/metrics',{headers:{Authorization:'Bearer ' + (process.env.METRICS_API_KEY||'')}}).then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

  # -------------------------
  # Prometheus (scrape /metrics API)
  # -------------------------
  prometheus:
    image: prom/prometheus:v2.55.0
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      api:
        condition: service_started
    networks:
      - default

  # -------------------------
  # Grafana (dashboards observabilité)
  # -------------------------
  grafana:
    image: grafana/grafana:10.4.5
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
    depends_on:
      prometheus:
        condition: service_started
    volumes:
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/provisioning/alerting:/etc/grafana/provisioning/alerting:ro
    networks:
      - default
  # -------------------------
  # Nginx (frontend + reverse proxy API / WS / Kienlab)
  # -------------------------      
  nginx:
    build:
      context: ..
      dockerfile: infra/nginx.Dockerfile
      args:
        # Config OIDC injectée dans le build Vite
        VITE_OIDC_ISSUER_URL: ${VITE_OIDC_ISSUER_URL:-http://192.168.2.30:8080/realms/iot}
        VITE_OIDC_CLIENT_ID: ${VITE_OIDC_CLIENT_ID:-iot-dashboard}
        VITE_OIDC_REDIRECT_URI: ${VITE_OIDC_REDIRECT_URI:-http://192.168.2.30:8081}
        VITE_REQUIRE_AUTH: ${VITE_REQUIRE_AUTH:-1}
    restart: unless-stopped

    ports:
      - "8081:80"
      # - "443:443"  # à activer avec TLS plus tard
    environment:
      # Proxy vers Kienlab
      KIENLAB_PROXY_TARGET: ${KIENLAB_PROXY_TARGET:-http://eprophet.kienlab.com}
    depends_on:
      api:
        condition: service_started
    volumes:
      - ./nginx/certs:/etc/nginx/certs:ro
    networks:
      - default

volumes:
  api_data: {}
  api_logs: {}
  keycloak_db_data: {}
  db_data: {}

networks:
  default:
    name: iot-net
